<% include templates/header.ejs %>
<body>

<div class="container">
    <% include templates/body.ejs %>
    <div class="row content">
        <% include templates/navbar.ejs %>
        <div class="col-sm-9">
            <h4 id="h4">Αποτελέσματα</h4>
            <form class="form-horizontal" method="post" action="/users/results">
                <div class="form-group">
                    <label class="control-label col-sm-2" for="year">Έτος:</label>
                    <div class="col-sm-7">
                        <select class="form-control" name="year">
                            <option>2017</option>
                            <option>2018</option>
                            <option>2019</option>
                            <option>2020</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-2" for="month">Μήνας:</label>
                    <div class="col-sm-7">
                        <select class="form-control" name="month">
                            <option>Ιανουάριος</option>
                            <option>Φεβρουάριος</option>
                            <option>Μάρτιος</option>
                            <option>Απρίλιος</option>
                            <option>Μάιος</option>
                            <option>Ιούνιος</option>
                            <option>Ιούλιος</option>
                            <option>Αύγουστος</option>
                            <option>Σεπτέμβριος</option>
                            <option>Οκτώβριος</option>
                            <option>Νοέμβριος</option>
                            <option>Δεκέμβριος</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Αναζήτηση</button>
                </form>
            <br>

        <%if(totalExpenses){%><!-- Αν έχουμε έξοδα τότε εμφανίζονται όλοι οι πίνακες) -->
            <h4 class="text-center">ΣΥΓΚΕΝΤΡΩΤΙΚΗ ΚΑΤΑΣΤΑΣΗ ΚΟΙΝΟΧΡΗΣΤΩΝ ΔΑΠΑΝΩΝ</h4>
            <h4 class="text-center">Μήνας: <%= expenses['Μήνας']%> - Έτος: <%= expenses['Έτος']%></h4>
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>'Εξοδα</th>
                    <th>Ποσό</th>
                </tr>
                </thead>
                <tbody>
                <% for(var key in expenses) {%>
                <% if(expenses.hasOwnProperty(key)){%>
                <% if(expenses[key]!=null && key!= 'Έτος' && key!= 'Μήνας'){%>
                <tr>
                    <%if(key==='Πετρέλαιο/Αέριο'){%>
                         <td><%=key%></td>
                         <td><%= ((100-blockHeatFixed)*expenses[key]/100).toFixed(2)%></td>
                         <tr>
                         <td>Πάγιο Θέρμανσης</td>
                         <td><%= (blockHeatFixed*expenses[key]/100).toFixed(2)%></td>
                </tr>
                    <%}else {%>
                        <td><%=key%></td>
                        <td><%= expenses[key].toFixed(2)%></td>
                    <%}%>
                </tr>
                <%}%>
                <%}%>
                <%}%>
                <tr>
                    <th>Σύνολο Εξόδων</th>
                    <th><%= totalExpenses.toFixed(2)%></th>
                </tr>

                </tbody>
            </table>

            <table class="table table-bordered">
                <thead>
                <tr>
                    <th class="text-center" colspan="2"></th>
                    <th class="text-center" colspan="3">ΧΙΛΙΙΟΣΤΑ ΕΠΙΒΑΡΥΝΣΕΙΣ</th>
                    <th class="text-center" colspan="6">ΕΠΙΒΑΡΥΝΣΕΙΣ ΣΕ ΕΥΡΩ</th>
                </tr>
                <tr>
                    <th>ΑΑ</th>
                    <th>Επώνυμο</th>
                    <th style="white-space:nowrap;">Κοιν/στων</th>
                    <th>Ασανσέρ</th>
                    <th class="text-center">Μονάδες Θέρμανσης</th>
                    <th style="white-space:nowrap;">Κοιν/στα</th>
                    <th>Ασανσέρ</th>
                    <th>Θέρμανση</th>
                    <th>Πάγιο</th>
                    <th>Ιδιοκτητών</th>
                    <th>Σύνολο</th>
                </tr>
                </thead>
                <tbody>

            <% if(typeof flatsShownNav !== 'undefined'){ %>
                <% var totalExpKoin=0 %>
                <% var totalExpLift=expenses['Ασανσέρ Συντήρηση']+expenses['Ασανσέρ Ανταλ. Επισκευή']%> <!-- Συνολικά έξοδα ασανσερ συντήρηση συν επισκευη ανταλλακτικά -->
                <% var count=0%>
                <% var sumΩixXil=0%>

            <!-- Υπολογισμός του sumOf(Ωi x Χιλιοστά θέρμανσης) -->
            <%  flatsShownNav.forEach(function( flatsShownNav){ %>
                <% sumΩixXil+= flatHeatCount[count].flatheatcount*flatsShownNav.koinratio %>
                <%count+=1%>
            <%})%>
            <% count=0%> <!-- Μηδενισμός του count για συνέχεια στον επόμενο υπολογισμό -->

            <!-- Υπολογισμός εξόδων για κάθε διαμέρισμα -->
            <%  flatsShownNav.forEach(function( flatsShownNav){ %>
                <tr>
                    <td><%=  flatsShownNav.flatNum %></td>
                    <td><%=  flatsShownNav.lastname %></td>
                    <td class="text-center"><%= flatsShownNav.koinratio %></td>
                    <td class="text-center"><%= flatsShownNav.liftratio %></td>
                    <td class="text-center"><%= flatHeatCount[count].flatheatcount%></td>
                    <td class="text-center"><%= ((flatsShownNav.koinratio*(totalExpenses-totalExpLift-expenses['Πετρέλαιο/Αέριο']))/1000).toFixed(2) %></td>
                    <td class="text-center"><%= ((flatsShownNav.liftratio*totalExpLift)/1000).toFixed(2) %></td>
                    <td class="text-center"><%= ((flatsShownNav.koinratio*flatHeatCount[count].flatheatcount*(100-blockHeatFixed)*expenses['Πετρέλαιο/Αέριο']/100)/sumΩixXil).toFixed(2) %></td>
                    <td class="text-center"><%= ((flatsShownNav.koinratio*blockHeatFixed*expenses['Πετρέλαιο/Αέριο']/100)/1000).toFixed(2) %></td>
                    <td></td>
                    <td class="text-center"><%=(((flatsShownNav.koinratio*(totalExpenses-totalExpLift-expenses['Πετρέλαιο/Αέριο']))/1000)+
                        ((flatsShownNav.liftratio*totalExpLift)/1000)+
                        ((flatsShownNav.koinratio*flatHeatCount[count].flatheatcount*(100-blockHeatFixed)*expenses['Πετρέλαιο/Αέριο']/100)/sumΩixXil)+
                        ((flatsShownNav.koinratio*blockHeatFixed*expenses['Πετρέλαιο/Αέριο']/100)/1000)).toFixed(2)%></td>
                </tr>
                    <%count+=1%>
            <% }) %>

            <!-- Υπολογισμός σύνολων τελευταίας γραμμής για έλεγχο -->
            <% var totalKin= 0%> <!-- Σύνολο χιλιοστά κοινοχρήστων-->
            <% var totalLift= 0%> <!-- Σύνολο χιλιοστά ασανερ -->
            <% var totalXil= 0%>
            <% var totalHeat=0%> <!-- Σύνολο εξοδα θέρμανσης -->
            <% var totalHeatFixed=0%> <!-- Σύνολο εξοδα πάγιο θέρμανσης -->
            <% var checkTotal=0%> <!-- Σύνολο εξόδων -->
            <% count=0%>

            <%  flatsShownNav.forEach(function( flatsShownNav){ %>
                <% totalKin+=flatsShownNav.koinratio%>
                <% totalLift+=flatsShownNav.liftratio%>
                <% totalXil+=flatsShownNav.flatxil%>
                <% totalExpKoin+=((flatsShownNav.koinratio*(totalExpenses-totalExpLift-expenses['Πετρέλαιο/Αέριο']))/1000)%>
                <% totalHeat+=(flatsShownNav.koinratio*flatHeatCount[count].flatheatcount*(100-blockHeatFixed)*expenses['Πετρέλαιο/Αέριο']/100)/sumΩixXil%>
                <% totalHeatFixed+=(flatsShownNav.koinratio*blockHeatFixed*expenses['Πετρέλαιο/Αέριο']/100)/1000%>
                <% checkTotal+=((flatsShownNav.koinratio*(totalExpenses-totalExpLift-expenses['Πετρέλαιο/Αέριο']))/1000)+((flatsShownNav.liftratio*totalExpLift)/1000)+((flatsShownNav.koinratio*flatHeatCount[count].flatheatcount*expenses['Πετρέλαιο/Αέριο'])/sumΩixXil)%>
                <%count+=1%>
            <%})%>

            <!-- Υπολογισμός σύνολο μονάδων θέρμανσης -->
            <%var totalCounts=0%> <!-- Σύνολο μονάδες Θέρμανσης-->
            <% for( var i=0; i<flatHeatCount.length; i++){%>
                <% totalCounts+=flatHeatCount[i].flatheatcount%>
            <%}%>

            <!-- Totals last row -->
            <tr>
                <th class="text-center" colspan="2">Σύνολα</th>
                <th class="text-center"><%= totalKin%></th> <!-- Σύνολο χιλιοστά κοινοχρήστων-->
                <th class="text-center"><%= totalLift%></th> <!-- Σύνολο χιλιοστά ασανερ -->
                <th class="text-center"><%= totalCounts%></th> <!-- Σύνολο μονάδες Θέρμανσης-->
                <th class="text-center"><%= totalExpKoin.toFixed(2)%></th> <!-- Σύνολο εξοδα κοινοχρήστων -->
                <th class="text-center"><%= totalExpLift.toFixed(2)%></th> <!-- Σύνολο εξοδα ασανσερ -->
                <th class="text-center"><%= totalHeat.toFixed(2)%></th> <!-- Σύνολο εξοδα θέρμανσης -->
                <th class="text-center"><%= totalHeatFixed.toFixed(2)%></th> <!-- Σύνολο εξοδα πάγιο θέρμανσης -->
                <th class="text-center"></th>
                <th class="text-center"><%= checkTotal.toFixed(2)%></th> <!-- Σύνολο εξόδων -->
            </tr>
            <%}%>
        <%}%><!-- end of if totalExpenses -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<% include templates/footer.ejs %>
</body>

</html>